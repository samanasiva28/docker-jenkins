pipeline {
    agent any

    environment {
        GCP_PROJECT = 'siva-sai-447213'
        CLUSTER_NAME = 'cluster-1'
        GKE_ZONE = 'us-central1-c'
    }

    stages {
        stage('Checkout Code') {
            steps {
                git "https://github.com/samanasiva28/docker-jenkins.git"
            }
        }

        stage('Build Docker Image') {
            steps {
                sh 'docker build -t myapp:latest .'
            }
        }

        stage('Login to Docker Hub') {
            steps {
                withCredentials([usernamePassword(credentialsId: 'docker', usernameVariable: 'DOCKER_USERNAME', passwordVariable: 'DOCKER_PASSWORD')]) {   
                    sh 'echo $DOCKER_PASSWORD | docker login -u $DOCKER_USERNAME --password-stdin'
                }
            }
        }

        stage('Push Docker Image') {
            steps {
                sh '''
                docker tag myapp:latest sivasai2003/myapp:latest
                docker push sivasai2003/myapp:latest
                '''
            }
        }

        stage('Authenticate with GCP') {
            steps {
                withCredentials([file(credentialsId: 'gcp-key', variable: 'GOOGLE_APPLICATION_CREDENTIALS')]) {
                    sh 'gcloud auth activate-service-account --key-file=$GOOGLE_APPLICATION_CREDENTIALS'
                    sh 'gcloud container clusters get-credentials $CLUSTER_NAME --zone $GKE_ZONE --project $GCP_PROJECT'
                }
            }
        }

        stage('Deploy to GKE') {
            steps {
                sh 'kubectl apply -f deploy.yml'
                sh 'kubectl apply -f service.yml'
            }
        }
    }
}
